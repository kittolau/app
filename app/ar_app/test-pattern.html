<!DOCTYPE html>
<html lang="en">
<head>
    <title>AR Viewer - Pattern Marker Test (Working Solution)</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- AR.js with Pattern Markers (More Reliable) -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        
        /* Ensure A-Frame scene is visible */
        a-scene {
            display: block !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
        }

        /* Instructions */
        #instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 144, 255, 0.9);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95em;
            z-index: 1500;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Status message */
        #status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .marker-link {
            color: #fbbf24;
            text-decoration: underline;
            cursor: pointer;
        }

        .success { color: #10b981; }
        .warning { color: #fbbf24; }
    </style>
</head>
<body>
    <!-- Instructions for users -->
    <div id="instructions">
        Ë´ãÂ∞áÁõ∏Ê©üÂ∞çÊ∫ñ <span class="marker-link" onclick="showHiroMarker()">HIRO Ê®ôË®ò</span> ‰ª•Êü•Áúã AR ÂÖßÂÆπ<br>
        <small>ÈÄôÊòØ‰∏ÄÂÄãÂèØÈù†ÁöÑÂúñÊ°àÊ®ôË®òËß£Ê±∫ÊñπÊ°à</small>
    </div>
    
    <!-- Status Message -->
    <div id="status-message">
        <h3 id="status-title">Marker Detected!</h3>
        <p id="status-text">Yang Liwei model is now visible</p>
    </div>
    
    <!-- AR.js Scene with Pattern Marker -->
    <a-scene 
        embedded 
        arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; patternRatio: 0.8;'
        vr-mode-ui="enabled: false" 
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;" 
        id="ar-scene">
        
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="yang-liwei-model" src="model/p_ylw/model.glb"></a-asset-item>
        </a-assets>
        
        <!-- HIRO Pattern Marker -->
        <a-marker preset="hiro" id="hiro-marker">
            <!-- 3D Model -->
            <a-gltf-model 
                id="yang-liwei-3d"
                src="#yang-liwei-model"
                position="0 0 0" 
                rotation="-90 0 0" 
                scale="0.5 0.5 0.5"
                animation="property: rotation; to: -90 360 0; dur: 10000; easing: linear; loop: true">
            </a-gltf-model>
            
            <!-- Enhanced Lighting -->
            <a-entity light="type: ambient; color: #FFF; intensity: 1"></a-entity>
            <a-entity light="type: directional; color: #FFF; intensity: 1.5" position="1 1 1"></a-entity>
            <a-entity light="type: hemisphere; color: #FFF; groundColor: #888; intensity: 0.8"></a-entity>
        </a-marker>
        
        <!-- Camera -->
        <a-entity camera></a-entity>
    </a-scene>
    
    <script>
        // Show status message
        function showStatus(title, text, duration = 3000) {
            var statusMsg = document.getElementById('status-message');
            var statusTitle = document.getElementById('status-title');
            var statusText = document.getElementById('status-text');
            
            statusTitle.textContent = title;
            statusText.textContent = text;
            statusMsg.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(function() {
                    statusMsg.style.display = 'none';
                }, duration);
            }
        }
        
        // Request camera permissions
        async function requestCameraPermission() {
            try {
                console.log('üé• Requesting camera permission...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                console.log('‚úÖ Camera permission granted');
                showStatus('Camera Ready', 'Camera permission granted, point at HIRO marker', 3000);
                // Stop the test stream
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error('‚ùå Camera permission denied:', error);
                showStatus('Camera Error', 'Please allow camera access to use AR features', 5000);
                return false;
            }
        }
        
        // Show HIRO marker
        function showHiroMarker() {
            // Create popup to show the HIRO marker
            var popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px;
                z-index: 3000; max-width: 80%; max-height: 80%;
            `;
            
            var img = document.createElement('img');
            img.src = 'https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png';
            img.style.cssText = 'max-width: 100%; max-height: 60vh; border-radius: 5px; background: white; padding: 20px;';
            
            var closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = `
                display: block; margin: 10px auto 0; padding: 8px 16px;
                background: #fff; border: none; border-radius: 5px; cursor: pointer;
            `;
            closeBtn.onclick = function() { document.body.removeChild(popup); };
            
            var title = document.createElement('p');
            title.textContent = 'Point camera at this HIRO marker:';
            title.style.cssText = 'color: white; text-align: center; margin: 0 0 10px 0;';
            
            var instructions = document.createElement('p');
            instructions.innerHTML = 'Print this marker or display it on another screen.<br>Works much better than NFT tracking!';
            instructions.style.cssText = 'color: #93c5fd; text-align: center; margin: 10px 0; font-size: 14px;';
            
            popup.appendChild(title);
            popup.appendChild(img);
            popup.appendChild(instructions);
            popup.appendChild(closeBtn);
            document.body.appendChild(popup);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Pattern Marker AR initializing...');
            
            // Request camera permissions first
            requestCameraPermission().then(function(granted) {
                if (granted) {
                    initializeMarkerEvents();
                } else {
                    showStatus('Camera Required', 'Please refresh and allow camera access', 0);
                }
            });
        });
        
        // Initialize marker events
        function initializeMarkerEvents() {
            // Wait for A-Frame scene to be ready
            var scene = document.querySelector('a-scene');
            if (!scene) {
                console.error('A-Frame scene not found');
                return;
            }
            
            scene.addEventListener('loaded', function() {
                console.log('‚úì A-Frame scene loaded');
                
                // Setup marker events
                var marker = document.querySelector('#hiro-marker');
                if (marker) {
                    // Marker found event
                    marker.addEventListener('markerFound', function() {
                        console.log('‚úÖ HIRO marker detected!');
                        showStatus('Marker Detected!', 'Yang Liwei model is now visible');
                        
                        // Hide instructions
                        var instructions = document.getElementById('instructions');
                        if (instructions) {
                            instructions.style.display = 'none';
                        }
                    });
                    
                    // Marker lost event
                    marker.addEventListener('markerLost', function() {
                        console.log('‚ùå HIRO marker lost');
                        showStatus('Marker Lost', 'Point camera back at the HIRO marker', 2000);
                        
                        // Show instructions again
                        var instructions = document.getElementById('instructions');
                        if (instructions) {
                            instructions.style.display = 'block';
                        }
                    });
                    
                    console.log('‚úì Pattern marker events configured');
                } else {
                    console.error('HIRO marker element not found');
                }
            });
        }
    </script>
</body>
</html>
