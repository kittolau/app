<!DOCTYPE html>
<html lang="en">
<head>
    <title>AR Viewer - Dynamic Model Loading</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
        // Configure A-Frame to use Draco decoder for compressed models
        if (typeof THREE !== 'undefined' && THREE.DRACOLoader) {
            THREE.DRACOLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
            console.log('‚úì Draco decoder configured');
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { margin: 0; overflow: hidden; }
        
        /* Ensure A-Frame scene is visible */
        a-scene {
            display: block !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
        }
        
        /* Loading Splash Screen */
        #loading-splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at bottom, #1e3a8a 0%, #0a0e27 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }

        #loading-splash.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Animated Stars Background */
        .loading-stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .loading-star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle linear infinite;
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Loading Content */
        .loading-content {
            position: relative;
            z-index: 1;
            text-align: center;
            max-width: 500px;
            padding: 40px 20px;
        }

        .loading-icon {
            font-size: 100px;
            margin-bottom: 30px;
            animation: rocket-float 2s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.6));
        }

        @keyframes rocket-float {
            0%, 100% {
                transform: translateY(0) rotate(-10deg);
            }
            50% {
                transform: translateY(-20px) rotate(-10deg);
            }
        }

        .loading-title {
            font-size: 2.5em;
            font-weight: 800;
            background: linear-gradient(135deg, #06b6d4 0%, #7c3aed 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            text-shadow: 0 0 30px rgba(124, 58, 237, 0.5);
        }

        .loading-subtitle {
            color: #93c5fd;
            font-size: 1.2em;
            margin-bottom: 40px;
            font-weight: 500;
        }

        /* Progress Bar Container */
        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 25px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 50px;
            padding: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .progress-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(124, 58, 237, 0.1) 50%, transparent 70%);
            animation: shine 3s linear infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #7c3aed 0%, #ec4899 50%, #06b6d4 100%);
            border-radius: 40px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.8);
            position: relative;
            z-index: 1;
        }

        .progress-text {
            color: #e0e7ff;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .progress-percentage {
            color: #fbbf24;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        /* Loading Status */
        .loading-status {
            color: #cbd5e1;
            font-size: 0.95em;
            min-height: 24px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(124, 58, 237, 0.3);
            border-top-color: #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Model List Info */
        .models-info {
            margin-top: 30px;
            padding: 20px;
            background: rgba(30, 58, 138, 0.3);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .models-info-title {
            color: #fbbf24;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .models-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .model-badge {
            background: rgba(124, 58, 237, 0.4);
            border: 1px solid rgba(124, 58, 237, 0.6);
            border-radius: 20px;
            padding: 6px 16px;
            color: #e0e7ff;
            font-size: 0.85em;
            font-weight: 500;
        }

        .model-badge.loaded {
            background: rgba(16, 185, 129, 0.4);
            border-color: rgba(16, 185, 129, 0.6);
            color: #10b981;
        }

        .model-badge.failed {
            background: rgba(239, 68, 68, 0.4);
            border-color: rgba(239, 68, 68, 0.6);
            color: #ef4444;
        }

        /* Error Panel */
        .error-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 500px;
            width: 90%;
            padding: 30px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.2) 100%);
            border: 2px solid rgba(239, 68, 68, 0.6);
            border-radius: 20px;
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 40px rgba(239, 68, 68, 0.3);
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-out;
        }

        .error-panel.visible {
            display: block;
            opacity: 1;
        }

        /* Error Panel Backdrop */
        .error-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-out;
        }

        .error-backdrop.visible {
            display: block;
            opacity: 1;
        }

        .error-title {
            color: #fbbf24;
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-align: center;
        }

        .error-message {
            color: #fecaca;
            font-size: 1em;
            margin-bottom: 20px;
            line-height: 1.6;
            text-align: center;
        }

        .failed-models-list {
            margin: 20px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }

        .failed-model-item {
            color: #fca5a5;
            padding: 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .error-buttons {
            text-align: center;
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .retry-button {
            background: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);
            color: white;
            border: none;
            padding: 14px 35px;
            border-radius: 14px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }

        .retry-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.6);
        }

        .retry-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .skip-button {
            background: rgba(100, 116, 139, 0.6);
            color: white;
            border: 2px solid rgba(100, 116, 139, 0.8);
            padding: 14px 35px;
            border-radius: 14px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .skip-button:hover {
            background: rgba(100, 116, 139, 0.8);
            transform: translateY(-2px);
        }

        .retry-info {
            color: #cbd5e1;
            font-size: 0.85em;
            margin-top: 15px;
            font-style: italic;
            text-align: center;
        }

        /* Responsive for error panel */
        @media (max-width: 540px) {
            .error-panel {
                width: 95%;
                padding: 25px 20px;
            }

            .error-title {
                font-size: 1.1em;
            }

            .retry-button,
            .skip-button {
                padding: 12px 25px;
                font-size: 0.95em;
            }

            .error-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .retry-button,
            .skip-button {
                width: 100%;
            }
        }

        /* AR message overlay */
        #ar-hover-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            max-width: 90%;
            text-align: center;
        }
        
        #ar-hover-message h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: bold;
        }

        /* Personal Info Card */
        #personal-info-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.95) 0%, rgba(124, 58, 237, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(124, 58, 237, 0.6);
            border-radius: 25px;
            padding: 30px;
            z-index: 1500;
            display: none;
            max-width: 95%;
            width: 800px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), 0 0 40px rgba(124, 58, 237, 0.5);
            animation: slideInFromSpace 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideInFromSpace {
            0% {
                transform: translate(-50%, -50%) scale(0.3) rotateY(180deg);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotateY(0deg);
                opacity: 1;
            }
        }

        .personal-info-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(251, 191, 36, 0.3);
            padding-bottom: 20px;
        }

        .personal-info-header .astronaut-icon {
            display: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .personal-info-header h2 {
            font-size: 2.2em;
            font-weight: 800;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .personal-info-header .nationality {
            color: #e0e7ff;
            font-size: 1.1em;
            font-weight: 500;
            opacity: 0.9;
        }

        .personal-info-content {
            color: #e0e7ff;
            line-height: 1.7;
        }

        .mission-section {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .mission-section h3 {
            color: #fbbf24;
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mission-section p {
            font-size: 1.05em;
            line-height: 1.8;
            text-align: justify;
        }

        .moto-section {
            background: rgba(236, 72, 153, 0.1);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .moto-section h3 {
            color: #ec4899;
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .moto-item {
            background: rgba(15, 23, 42, 0.6);
            border-left: 4px solid #ec4899;
            padding: 15px 20px;
            margin: 12px 0;
            border-radius: 0 10px 10px 0;
            font-style: italic;
            font-size: 1.05em;
            position: relative;
        }

        .moto-item::before {
            content: '"';
            position: absolute;
            left: -5px;
            top: -10px;
            font-size: 3em;
            color: #ec4899;
            font-family: serif;
        }

        .birth-info {
            text-align: center;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            color: #06b6d4;
            font-weight: 600;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        .video-section {
            text-align: center;
            margin: 25px 0 10px;
            padding-top: 20px;
            border-top: 1px solid rgba(124, 58, 237, 0.3);
        }

        .personal-video-btn {
            background: linear-gradient(135deg, #ec4899 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .personal-video-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.6);
            background: linear-gradient(135deg, #f97316 0%, #dc2626 100%);
        }

        .personal-video-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Introduction Info Card */
        #introduction-info-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.95) 0%, rgba(16, 185, 129, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(6, 182, 212, 0.6);
            border-radius: 25px;
            padding: 30px;
            z-index: 1500;
            display: none;
            max-width: 90%;
            width: 600px;
            max-height: 70%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), 0 0 40px rgba(6, 182, 212, 0.5);
            animation: slideInFromSpace 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .intro-info-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(251, 191, 36, 0.3);
            padding-bottom: 20px;
        }

        .intro-icon {
            font-size: 6em;
            margin-bottom: 20px;
            display: none;
            animation: rocket-float 2s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.8));
        }

        .intro-icon.show {
            display: block !important;
        }

        @keyframes rocket-float {
            0%, 100% {
                transform: translateY(0px) rotate(-10deg);
            }
            50% {
                transform: translateY(-15px) rotate(-10deg);
            }
        }

        .intro-info-header h2 {
            font-size: 2em;
            font-weight: 800;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .intro-info-content {
            color: #e0e7ff;
            line-height: 1.7;
        }

        .intro-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .intro-speak-btn {
            background: linear-gradient(135deg, #7c3aed 0%, #ec4899 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
            min-width: 200px;
            justify-content: center;
        }

        .intro-speak-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.6);
        }

        .intro-speak-btn.speaking {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .intro-speak-btn.speaking:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
        }

        .intro-video-section {
            width: 100%;
            text-align: center;
        }

        .intro-video-btn {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.4);
            min-width: 200px;
            justify-content: center;
        }

        .intro-video-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.6);
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }

        .intro-speak-btn svg,
        .intro-video-btn svg {
            width: 18px;
            height: 18px;
        }
        
        #speak-button {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(calc(-100% - 10px));
            background-color: rgba(33, 150, 243, 0.9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s;
        }
        
        #speak-button:hover {
            background-color: rgba(33, 150, 243, 1);
        }
        
        #speak-button:active {
            background-color: rgba(25, 118, 210, 1);
        }
        
        #speak-button.speaking {
            background-color: rgba(244, 67, 54, 0.9);
        }
        
        #speak-button.speaking:hover {
            background-color: rgba(244, 67, 54, 1);
        }
        
        #youtube-button {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(10px);
            background-color: rgba(255, 0, 0, 0.9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s;
        }
        
        #youtube-button:hover {
            background-color: rgba(255, 0, 0, 1);
        }
        
        #youtube-button:active {
            background-color: rgba(204, 0, 0, 1);
        }
        
        #youtube-button svg {
            vertical-align: middle;
            margin-right: 8px;
        }
        
        #video-button {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(10px);
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s;
        }
        
        #video-button:hover {
            background-color: rgba(76, 175, 80, 1);
        }
        
        #video-button:active {
            background-color: rgba(56, 142, 60, 1);
        }
        
        #video-button svg {
            vertical-align: middle;
            margin-right: 8px;
        }
        
        /* Instructions */
        #instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 144, 255, 0.9);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 0.95em;
            z-index: 1500;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* Responsive adjustments */
        @media (max-width: 540px) {
            #ar-hover-message {
                font-size: 1.3em;
                padding: 16px 24px;
            }
            
            #instructions {
                font-size: 0.85em;
                padding: 10px 16px;
            }

            .loading-title {
                font-size: 2em;
            }

            .loading-icon {
                font-size: 80px;
            }

            .progress-container {
                max-width: 90%;
            }

            .loading-content {
                padding: 20px 15px;
            }
            
            /* Personal info card responsive */
            #personal-info-card {
                max-width: 95%;
                max-height: 85%;
                padding: 20px 15px;
                border-radius: 20px;
            }
            
            .personal-info-header h2 {
                font-size: 1.8em;
            }
            
            .mission-section,
            .moto-section {
                padding: 15px;
                margin: 15px 0;
            }
            
            .mission-section h3,
            .moto-section h3 {
                font-size: 1.2em;
            }
            
            .close-btn {
                top: 10px;
                right: 15px;
                width: 30px;
                height: 30px;
                font-size: 1em;
            }
            
            .personal-video-btn {
                padding: 12px 25px;
                font-size: 1em;
            }
            
            /* Introduction info card responsive */
            #introduction-info-card {
                max-width: 95%;
                width: auto;
                padding: 20px 15px;
            }
            
            .intro-icon {
                font-size: 4em;
                margin-bottom: 15px;
            }
            
            .intro-info-header h2 {
                font-size: 1.6em;
            }
            
            .intro-speak-btn,
            .intro-video-btn {
                padding: 12px 25px;
                font-size: 1em;
                min-width: 180px;
            }
            
            /* MC Game card responsive */
            #mc-game-card {
                max-width: 95%;
                width: auto;
                padding: 25px 20px;
            }
            
            .mission-brief-icon {
                font-size: 3em;
                margin-bottom: 12px;
            }
            
            .mission-brief-title {
                font-size: 1.5em;
            }
            
            .mission-accept-btn {
                padding: 12px 30px;
                font-size: 1em;
            }
        }

        /* MC Game Mission Briefing Card */
        #mc-game-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: linear-gradient(135deg, 
                #1a1a2e 0%, 
                #16213e 25%, 
                #0f3460 50%, 
                #16213e 75%, 
                #1a1a2e 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 40px rgba(251, 191, 36, 0.15);
            color: white;
            z-index: 1001;
            max-width: 420px;
            width: 90%;
            padding: 30px;
            text-align: center;
            display: none;
            animation: mission-brief-enter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .mission-brief-header {
            margin-bottom: 25px;
            position: relative;
        }

        .mission-brief-icon {
            font-size: 4em;
            margin-bottom: 15px;
            animation: mission-pulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.8));
        }

        .mission-brief-title {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #fbbf24;
            text-shadow: 0 2px 10px rgba(251, 191, 36, 0.3);
            letter-spacing: 1px;
        }

        .mission-brief-subtitle {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            padding-bottom: 15px;
        }

        .mission-accept-btn {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a1a2e;
            border: none;
            padding: 15px 35px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 
                0 8px 25px rgba(251, 191, 36, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .mission-accept-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 35px rgba(251, 191, 36, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .mission-accept-btn:active {
            transform: translateY(0);
        }

        .mission-accept-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .mission-accept-btn:hover::before {
            left: 100%;
        }

        @keyframes mission-brief-enter {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8) rotateY(10deg);
                filter: blur(10px);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.95) rotateY(0deg);
                filter: blur(0);
            }
        }

        @keyframes mission-pulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.8));
            }
            50% {
                transform: scale(1.05);
                filter: drop-shadow(0 0 25px rgba(251, 191, 36, 1));
            }
        }
    </style>
</head>
<body>
    <!-- Error Backdrop -->
    <div class="error-backdrop" id="error-backdrop"></div>

    <!-- Loading Splash Screen -->
    <div id="loading-splash">
        <div class="loading-stars" id="loading-stars"></div>
        <div class="loading-content">
            <div class="loading-icon">üöÄ</div>
            <div class="loading-title">AR Viewer</div>
            <div class="loading-subtitle">Ê≠£Âú®Ê∫ñÂÇô AR È´îÈ©ó</div>
            
            <div class="progress-percentage" id="progress-percentage">0%</div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            
            <div class="progress-text">
                <span id="progress-text">ÂàùÂßãÂåñ‰∏≠...</span>
            </div>
            
            <div class="loading-status">
                <span class="loading-spinner"></span>
                <span id="loading-status">ËºâÂÖ•ÈÖçÁΩÆÊ™îÊ°à...</span>
            </div>

            <div class="models-info" id="models-info" style="display: none;">
                <div class="models-info-title">üõ∞Ô∏è ËºâÂÖ•Ê®°Âûã</div>
                <div class="models-list" id="models-list"></div>
            </div>

            <div class="error-panel" id="error-panel">
                <div class="error-title">‚ö†Ô∏è ÈÉ®ÂàÜÊ®°ÂûãËºâÂÖ•Â§±Êïó</div>
                <div class="error-message">
                    ‰ª•‰∏ãÊ®°ÂûãÁÑ°Ê≥ïËºâÂÖ•„ÄÇÊÇ®ÂèØ‰ª•ÈÅ∏ÊìáÈáçË©¶ÊàñË∑≥ÈÅéÈÄô‰∫õÊ®°ÂûãÁπºÁ∫å‰ΩøÁî®ÂÖ∂‰ªñÂäüËÉΩ„ÄÇ
                </div>
                <div class="failed-models-list" id="failed-models-list"></div>
                <div class="error-buttons">
                    <button class="retry-button" id="retry-button" onclick="retryFailedModels()">
                        üîÑ ÈáçË©¶ËºâÂÖ•
                    </button>
                    <button class="skip-button" id="skip-button" onclick="skipFailedModels()">
                        ‚è≠Ô∏è Ë∑≥ÈÅéÁπºÁ∫å
                    </button>
                </div>
                <div class="retry-info" id="retry-info"></div>
            </div>
        </div>
    </div>
    

    <!-- Instructions for users -->
    <div id="instructions">
        Ë´ãÂ∞áÁõ∏Ê©üÂ∞çÊ∫ñARÊ®ôË®ò‰ª•Êü•Áúã
    </div>
    
    <!-- AR message when marker is detected -->
    <div id="ar-hover-message">
        <h3 id="model-title">Model Detected</h3>
    </div>
    
    <!-- Personal Info Card for astronauts/personnel -->
    <div id="personal-info-card">
        <button class="close-btn" onclick="hidePersonalInfo()">√ó</button>
        <div class="personal-info-header">
            <span class="astronaut-icon">üë®‚ÄçüöÄ</span>
            <h2 id="person-name">Â§™Á©∫‰∫∫</h2>
            <div class="nationality" id="person-nationality">ÂúãÁ±ç</div>
        </div>
        <div class="personal-info-content">
            <div class="birth-info">
                <span id="person-birth">Âá∫ÁîüÊó•Êúü</span>
            </div>
            <div class="mission-section">
                <h3>üöÄ ‰∏ªË¶Å‰ªªÂãô</h3>
                <p id="person-mission">‰∏ªË¶Å‰ªªÂãôÊèèËø∞</p>
            </div>
            <div class="moto-section">
                <h3>üí¨ Á∂ìÂÖ∏Ë™ûÈåÑ</h3>
                <div id="person-moto-list">
                    <!-- Moto items will be populated by JavaScript -->
                </div>
            </div>
            <div class="video-section" id="person-video-section" style="display: none;">
                <button class="personal-video-btn" id="personal-video-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <span id="personal-video-text">ËßÄÁúãÂΩ±Áâá</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Introduction Info Card for missions/projects -->
    <div id="introduction-info-card">
        <button class="close-btn" onclick="hideIntroductionInfo()">√ó</button>
        <div class="intro-info-header">
            <div class="intro-icon" id="intro-icon" style="display: none;">üöÄ</div>
            <h2 id="intro-title">È†ÖÁõÆ‰ªãÁ¥π</h2>
        </div>
        <div class="intro-info-content">
            <div class="intro-actions">
                <button class="intro-speak-btn" id="intro-speak-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                    <span id="intro-speak-text">üîä Ë™ûÈü≥‰ªãÁ¥π</span>
                </button>
                
                <div class="intro-video-section" id="intro-video-section" style="display: none;">
                    <button class="intro-video-btn" id="intro-video-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <span id="intro-video-text">ËßÄÁúãÂΩ±Áâá</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MC Game Mission Briefing Card -->
    <div id="mc-game-card">
        <button class="close-btn" onclick="hideMCGameInfo()">√ó</button>
        <div class="mission-brief-header">
            <div class="mission-brief-icon">üéØ</div>
            <h2 class="mission-brief-title" id="mc-game-title">‰ªªÂãôÊåëÊà∞</h2>
            <div class="mission-brief-subtitle">Challenge Mission</div>
        </div>
        <div class="mission-brief-content">
            <button class="mission-accept-btn" id="mc-game-accept-btn">
                Êé•ÂèóÊåëÊà∞
            </button>
        </div>
    </div>
    
    <button id="speak-button">üîä Èü≥È†ªËß£Ë™™</button>
    
    <button id="youtube-button">
        <svg width="20" height="14" viewBox="0 0 20 14" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M19.582 2.186c-.23-.86-.907-1.537-1.768-1.768C16.254 0 10 0 10 0S3.746 0 2.186.418c-.86.23-1.537.908-1.768 1.768C0 3.746 0 7 0 7s0 3.254.418 4.814c.23.86.908 1.537 1.768 1.768C3.746 14 10 14 10 14s6.254 0 7.814-.418c.86-.23 1.537-.908 1.768-1.768C20 10.254 20 7 20 7s0-3.254-.418-4.814zM8 10V4l5.196 3L8 10z"/>
        </svg>
        ËßÄÁúãÂΩ±Áâá
    </button>
    
    <button id="video-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 5v14l11-7z"/>
        </svg>
        Êí≠ÊîæÂΩ±Áâá
    </button>
    
    <!-- A-Frame AR Scene -->
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;' vr-mode-ui="enabled: false" renderer="colorManagement: true; physicallyCorrectLights: true;" id="ar-scene">
        <!-- Global lighting for PBR materials -->
        <a-entity light="type: ambient; color: #BBB; intensity: 1"></a-entity>
        <a-entity light="type: hemisphere; color: #FFF; groundColor: #888; intensity: 1"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="-1 2 1"></a-entity>
        
        <!-- Multiple markers - AR.js can handle pattern markers and barcodes -->
        <a-entity camera></a-entity>
    </a-scene>
    
    <script>
        // Global variables for multi-model support
        var modelConfigs = {};
        var modelDescriptions = {};
        var availableModels = [];
        var currentModel = null;
        var speechSynthesis = window.speechSynthesis;
        var currentUtterance = null;
        
        // Loading progress tracking
        var loadingProgress = {
            total: 0,
            loaded: 0,
            currentTask: '',
            modelsLoaded: {},
            failedModels: [],
            retryCount: {}
        };

        var MAX_RETRIES = 3;
        var TIMEOUT_MS = 10000; // 10 seconds
        
        console.log('=== AR Viewer (Multi-Marker Support - Pattern & Barcode) ===');

        // Generate loading screen stars
        function createLoadingStars() {
            var starsContainer = document.getElementById('loading-stars');
            if (!starsContainer) return;
            
            var starCount = 100;
            for (var i = 0; i < starCount; i++) {
                var star = document.createElement('div');
                star.className = 'loading-star';
                
                var size = Math.random() * 3 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                star.style.animationDelay = Math.random() * 3 + 's';
                
                starsContainer.appendChild(star);
            }
        }

        // Update loading progress UI
        function updateLoadingProgress(percentage, task, status) {
            var progressBar = document.getElementById('progress-bar');
            var progressPercentage = document.getElementById('progress-percentage');
            var progressText = document.getElementById('progress-text');
            var loadingStatus = document.getElementById('loading-status');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            if (progressPercentage) {
                progressPercentage.textContent = Math.round(percentage) + '%';
            }
            if (progressText && task) {
                progressText.textContent = task;
            }
            if (loadingStatus && status) {
                loadingStatus.textContent = status;
            }
        }

        // Update model badges
        function updateModelBadges(modelName, loaded) {
            var modelsInfo = document.getElementById('models-info');
            var modelsList = document.getElementById('models-list');
            
            if (!modelsInfo || !modelsList) return;
            
            // Show models info section
            modelsInfo.style.display = 'block';
            
            // Find or create badge
            var badgeId = 'badge-' + modelName;
            var badge = document.getElementById(badgeId);
            
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'model-badge';
                badge.id = badgeId;
                badge.textContent = modelName;
                modelsList.appendChild(badge);
            }
            
            if (loaded) {
                badge.classList.add('loaded');
                badge.textContent = '‚úì ' + modelName;
            }
        }
        
        // Format file size to human readable format
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        // Hide loading splash
        function hideLoadingSplash() {
            var splash = document.getElementById('loading-splash');
            var scene = document.querySelector('a-scene');
            
            console.log('üé¨ Starting AR experience...');
            
            if (splash) {
                // Ensure scene is visible
                if (scene) {
                    scene.style.display = 'block';
                    scene.style.visibility = 'visible';
                }
                
                // Final check and log video status
                var video = document.querySelector('video');
                if (video) {
                    console.log('üìπ Final video check - Dimensions:', video.videoWidth, 'x', video.videoHeight);
                    console.log('üìπ Video ready state:', video.readyState);
                    console.log('üìπ Video paused:', video.paused);
                } else {
                    console.warn('‚ö†Ô∏è No video element when hiding splash');
                }
                
                // Hide splash with animation
                splash.classList.add('hidden');
                setTimeout(function() {
                    splash.style.display = 'none';
                    console.log('‚úì Loading splash hidden, AR experience started');
                }, 500);
            }
        }

        // Show error panel for failed models
        function showErrorPanel() {
            var errorPanel = document.getElementById('error-panel');
            var errorBackdrop = document.getElementById('error-backdrop');
            var failedModelsList = document.getElementById('failed-models-list');
            var retryInfo = document.getElementById('retry-info');
            var retryButton = document.getElementById('retry-button');
            var skipButton = document.getElementById('skip-button');
            
            if (!errorPanel || !failedModelsList) {
                console.error('Error panel elements not found');
                return;
            }
            
            console.log('üì¢ Showing error panel for failed models:', loadingProgress.failedModels);
            
            // Re-enable buttons
            if (retryButton) retryButton.disabled = false;
            if (skipButton) skipButton.disabled = false;
            
            // Clear previous content
            failedModelsList.innerHTML = '';
            
            // Add failed models to list
            loadingProgress.failedModels.forEach(function(modelName) {
                var retryCount = loadingProgress.retryCount[modelName] || 0;
                var item = document.createElement('div');
                item.className = 'failed-model-item';
                item.innerHTML = '‚ùå <strong>' + modelName + '</strong> (Â∑≤ÈáçË©¶ ' + retryCount + ' Ê¨°)';
                failedModelsList.appendChild(item);
            });
            
            // Update retry info
            if (retryInfo) {
                retryInfo.textContent = 'ÊèêÁ§∫: ÊØèÂÄãÊ®°ÂûãÊúÄÂ§öÈáçË©¶ ' + MAX_RETRIES + ' Ê¨°ÔºåË∂ÖÊôÇÊôÇÈñìÁÇ∫ ' + (TIMEOUT_MS / 1000) + ' Áßí';
            }
            
            // Show backdrop first
            if (errorBackdrop) {
                errorBackdrop.style.display = 'block';
                setTimeout(function() {
                    errorBackdrop.classList.add('visible');
                }, 10);
            }
            
            // Then show panel with animation
            errorPanel.style.display = 'block';
            setTimeout(function() {
                errorPanel.classList.add('visible');
            }, 10);
            
            console.log('‚úì Error panel displayed');
        }

        // Hide error panel
        function hideErrorPanel() {
            var errorPanel = document.getElementById('error-panel');
            var errorBackdrop = document.getElementById('error-backdrop');
            
            if (errorPanel) {
                errorPanel.classList.remove('visible');
                setTimeout(function() {
                    errorPanel.style.display = 'none';
                }, 400);
            }
            
            if (errorBackdrop) {
                errorBackdrop.classList.remove('visible');
                setTimeout(function() {
                    errorBackdrop.style.display = 'none';
                }, 400);
            }
        }

        // Retry failed models
        function retryFailedModels() {
            var retryButton = document.getElementById('retry-button');
            var skipButton = document.getElementById('skip-button');
            
            if (retryButton) retryButton.disabled = true;
            if (skipButton) skipButton.disabled = true;
            
            updateLoadingProgress(10, 'ÈáçË©¶ËºâÂÖ•Â§±ÊïóÁöÑÊ®°Âûã...', 'Ê∫ñÂÇôÈáçÊñ∞‰∏ãËºâ...');
            
            var failedModelsToRetry = loadingProgress.failedModels.slice();
            loadingProgress.failedModels = [];
            
            // Reset loaded counter for accurate progress
            loadingProgress.loaded = 0;
            loadingProgress.total = failedModelsToRetry.length;
            
            var retryPromises = failedModelsToRetry.map(function(modelName, index) {
                return loadModelConfig(modelName, index);
            });
            
            Promise.all(retryPromises).then(function() {
                if (loadingProgress.failedModels.length === 0) {
                    // All succeeded
                    hideErrorPanel();
                    updateLoadingProgress(70, 'ÈáçË©¶ÊàêÂäü', 'ÊâÄÊúâÊ®°ÂûãÂ∑≤ËºâÂÖ•ÔºåÂàùÂßãÂåñ AR Â†¥ÊôØ...');
                    
                    // Reinitialize the scene with all models
                    initializeARScene();
                } else {
                    // Some still failed
                    if (retryButton) retryButton.disabled = false;
                    if (skipButton) skipButton.disabled = false;
                    showErrorPanel();
                    updateLoadingProgress(50, 'ÈÉ®ÂàÜÊ®°Âûã‰ªçÁÑ∂Â§±Êïó', loadingProgress.failedModels.length + ' ÂÄãÊ®°ÂûãÁÑ°Ê≥ïËºâÂÖ•');
                }
            });
        }

        // Skip failed models and continue
        function skipFailedModels() {
            hideErrorPanel();
            
            console.warn('‚ö†Ô∏è Skipping failed models:', loadingProgress.failedModels);
            updateLoadingProgress(70, 'Ë∑≥ÈÅéÂ§±ÊïóÁöÑÊ®°Âûã', 'ÁπºÁ∫åÂàùÂßãÂåñ AR Â†¥ÊôØ...');
            
            // Remove failed models from available list
            availableModels = availableModels.filter(function(name) {
                return loadingProgress.failedModels.indexOf(name) === -1;
            });
            
            console.log('‚úì Available models after skipping:', availableModels);
            
            initializeARScene();
        }

        // Fetch with timeout
        function fetchWithTimeout(url, timeout) {
            return new Promise(function(resolve, reject) {
                var timeoutId = setTimeout(function() {
                    reject(new Error('Ë´ãÊ±ÇË∂ÖÊôÇ (timeout after ' + (timeout / 1000) + 's)'));
                }, timeout);
                
                fetch(url)
                    .then(function(response) {
                        clearTimeout(timeoutId);
                        resolve(response);
                    })
                    .catch(function(error) {
                        clearTimeout(timeoutId);
                        reject(error);
                    });
            });
        }

        // Initialize loading screen
        createLoadingStars();
        
        // Function to setup orbit animation
        function setupOrbitAnimation(orbitContainer, speed) {
            var currentAngle = 0;
            var rotationSpeed = speed * 0.5; // Adjust speed multiplier
            
            // Animation loop
            function animate() {
                if (orbitContainer && orbitContainer.object3D) {
                    currentAngle += rotationSpeed;
                    if (currentAngle >= 360) {
                        currentAngle -= 360;
                    }
                    orbitContainer.object3D.rotation.y = currentAngle * Math.PI / 180;
                }
                requestAnimationFrame(animate);
            }
            
            // Start animation
            animate();
        }
        
        // Load model list and cache all configurations
        updateLoadingProgress(5, 'ËºâÂÖ•‰∏≠...', 'ËÆÄÂèñÊ®°ÂûãÂàóË°®...');
        
        fetch('model/model_list.json')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Model list not found');
                }
                return response.json();
            })
            .then(function(data) {
                console.log('‚úì Model list loaded:', data);
                availableModels = data.models || [];
                loadingProgress.total = availableModels.length;
                
                updateLoadingProgress(10, 'Ê®°ÂûãÂàóË°®Â∑≤ËºâÂÖ•', 'ÊâæÂà∞ ' + availableModels.length + ' ÂÄãÊ®°Âûã');
                
                // Load and cache all model configurations
                return Promise.all(availableModels.map(function(modelName, index) {
                    return loadModelConfig(modelName, index);
                }));
            })
            .then(function() {
                console.log('‚úì All model configurations cached');
                console.log('Available models:', Object.keys(modelConfigs));
                
                // Check if there are any failed models
                if (loadingProgress.failedModels.length > 0) {
                    console.warn('‚ö†Ô∏è Some models failed to load:', loadingProgress.failedModels);
                    updateLoadingProgress(60, 'ÈÉ®ÂàÜÊ®°ÂûãËºâÂÖ•Â§±Êïó', loadingProgress.failedModels.length + ' ÂÄãÊ®°ÂûãÁÑ°Ê≥ïËºâÂÖ•');
                    showErrorPanel();
                    // Don't proceed automatically - wait for user decision
                } else {
                    // All models loaded successfully
                    updateLoadingProgress(70, 'ÈÖçÁΩÆÂÆåÊàê', 'ÂàùÂßãÂåñ AR Â†¥ÊôØ...');
                    initializeARScene();
                }
            })
            .catch(function(error) {
                console.error('‚ö†Ô∏è Failed to load model configurations:', error);
                updateLoadingProgress(50, 'ËºâÂÖ•Â§±Êïó', 'ÁôºÁîüÈåØË™§...');
                
                // Check if we have any failed models to show error panel
                if (loadingProgress.failedModels.length > 0) {
                    showErrorPanel();
                } else {
                    // Fallback to single model mode
                    initializeFallbackMode();
                    setTimeout(function() {
                        hideLoadingSplash();
                    }, 1000);
                }
            });
        
        // Load configuration for a specific model
        function loadModelConfig(modelName, index) {
            // Initialize retry count if not exists
            if (!loadingProgress.retryCount[modelName]) {
                loadingProgress.retryCount[modelName] = 0;
            }
            
            // Update progress for this model
            var currentProgress = 10 + (index / loadingProgress.total) * 50;
            var attemptText = loadingProgress.retryCount[modelName] > 0 
                ? ' (ÈáçË©¶ ' + loadingProgress.retryCount[modelName] + '/' + MAX_RETRIES + ')' 
                : '';
            updateLoadingProgress(
                currentProgress, 
                'ËºâÂÖ•Ê®°ÂûãÈÖçÁΩÆ...', 
                'Ê≠£Âú®ËôïÁêÜ: ' + modelName + attemptText
            );
            updateModelBadges(modelName, false);
            
            return fetchWithTimeout('model/' + modelName + '/config.json', TIMEOUT_MS)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    // Cache model configuration
                    modelConfigs[modelName] = {
                        size: data.size || 0.3,
                        posX: data.position ? data.position.x || 0 : 0,
                        posY: data.position ? data.position.y || 0 : 0,
                        posZ: data.position ? data.position.z || 0 : 0,
                        rotX: data.rotation ? data.rotation.x || 0 : 0,
                        rotY: data.rotation ? data.rotation.y || 0 : 0,
                        rotZ: data.rotation ? data.rotation.z || 0 : 0,
                        markerType: data.marker_type || 'pattern', // 'pattern' or 'barcode'
                        modelFile: data.model_file || 'model.gltf', // Support both .gltf and .glb files
                        // Orbit animation settings
                        spinAroundEarth: data.spin_around_earth_orbit || false,
                        earth: data.earth ? {
                            modelFile: data.earth.model_file || null,
                            size: data.earth.size || 0.5,
                            posX: data.earth.position ? data.earth.position.x || 0 : 0,
                            posY: data.earth.position ? data.earth.position.y || 0 : 0,
                            posZ: data.earth.position ? data.earth.position.z || 0 : 0,
                            rotX: data.earth.rotation ? data.earth.rotation.x || 0 : 0,
                            rotY: data.earth.rotation ? data.earth.rotation.y || 0 : 0,
                            rotZ: data.earth.rotation ? data.earth.rotation.z || 0 : 0
                        } : null,
                        orbitRadius: data.orbit_radius || 2,
                        orbitSpeed: data.orbit_speed || 1,
                        orbitTilt: data.orbit_tilt || 0
                    };
                    
                    // Cache description info and personal info
                    modelDescriptions[modelName] = {
                        title: data.desc_info ? data.desc_info.title || modelName : modelName,
                        hk_narrative: data.desc_info ? data.desc_info.hk_narrative || 'AR Model' : 'AR Model',
                        youtube_video_src: data.desc_info ? data.desc_info.youtube_video_src || null : null,
                        local_video_src: data.desc_info ? data.desc_info.local_video_src || null : null,
                        // Personal info for astronauts/personnel
                        personal_info: data.personal_info || null,
                        // Introduction info for missions/projects
                        introduction_info: data.introduction_info || null,
                        // MC Game info for interactive games
                        mc_game: data.mc_game || null
                    };
                    
                    console.log('‚úì Cached config for:', modelName, '(Type:', data.marker_type || 'pattern', ', Model:', data.model_file || 'model.gltf', ')');
                    
                    // Update loading progress
                    loadingProgress.loaded++;
                    loadingProgress.modelsLoaded[modelName] = true;
                    
                    // Remove from failed list if it was there
                    var failedIndex = loadingProgress.failedModels.indexOf(modelName);
                    if (failedIndex > -1) {
                        loadingProgress.failedModels.splice(failedIndex, 1);
                    }
                    
                    var loadedProgress = 10 + (loadingProgress.loaded / loadingProgress.total) * 60;
                    updateLoadingProgress(
                        loadedProgress,
                        'Â∑≤ËºâÂÖ• ' + loadingProgress.loaded + '/' + loadingProgress.total + ' ÂÄãÊ®°Âûã',
                        '‚úì ' + modelName + ' ÈÖçÁΩÆÂÆåÊàê'
                    );
                    updateModelBadges(modelName, true);
                })
                .catch(function(error) {
                    console.error('‚ö†Ô∏è Failed to load config for', modelName, ':', error);
                    loadingProgress.retryCount[modelName]++;
                    
                    // Check if we should retry
                    if (loadingProgress.retryCount[modelName] < MAX_RETRIES) {
                        console.log('üîÑ Retrying', modelName, '(attempt', loadingProgress.retryCount[modelName] + 1, 'of', MAX_RETRIES + ')');
                        // Retry with a small delay
                        return new Promise(function(resolve) {
                            setTimeout(function() {
                                resolve(loadModelConfig(modelName, index));
                            }, 1000);
                        });
                    } else {
                        // Max retries reached, mark as failed
                        console.error('‚ùå Max retries reached for', modelName);
                        loadingProgress.loaded++;
                        
                        // Add to failed models list if not already there
                        if (loadingProgress.failedModels.indexOf(modelName) === -1) {
                            loadingProgress.failedModels.push(modelName);
                        }
                        
                        updateLoadingProgress(
                            10 + (loadingProgress.loaded / loadingProgress.total) * 60,
                            'Â∑≤ËôïÁêÜ ' + loadingProgress.loaded + '/' + loadingProgress.total + ' ÂÄãÊ®°Âûã',
                            '‚ùå ' + modelName + ' ËºâÂÖ•Â§±Êïó (Â∑≤ÈáçË©¶ ' + MAX_RETRIES + ' Ê¨°)'
                        );
                        updateModelBadges(modelName, false);
                        
                        // Mark badge as failed
                        var badge = document.getElementById('badge-' + modelName);
                        if (badge) {
                            badge.classList.add('failed');
                            badge.textContent = '‚ùå ' + modelName;
                        }
                        
                        // Set default config for failed models
                        // Set default config for failed models
                        modelConfigs[modelName] = {
                            size: 0.3, posX: 0, posY: 0, posZ: 0, rotX: 0, rotY: 0, rotZ: 0
                        };
                        modelDescriptions[modelName] = {
                            title: modelName,
                            hk_narrative: 'AR Model',
                            youtube_video_src: null,
                            local_video_src: null,
                            personal_info: null,
                            introduction_info: null,
                            mc_game: null
                        };
                    }
                });
        }
        
        // Initialize AR scene with multiple markers
        function initializeARScene() {
            console.log('üé¨ Initializing AR scene with models:', availableModels);
            updateLoadingProgress(75, 'ÂàùÂßãÂåñ AR Â†¥ÊôØ', 'Ë®≠ÁΩÆÊ®ôË®òÂíåÊ®°Âûã...');
            
            var scene = document.getElementById('ar-scene');
            if (!scene) {
                console.error('AR scene not found');
                return;
            }
            
            if (availableModels.length === 0) {
                console.error('No models available');
                return;
            }
            
            // Create a marker for each model - AR.js will detect whichever is visible
            availableModels.forEach(function(modelName) {
                createMarkerForModel(scene, modelName);
            });
            
            console.log('‚úì AR scene initialized with', availableModels.length, 'markers');
            
            // Wait for all assets to be loaded before proceeding
            waitForAssetsToLoad();
        }
        
        // Wait for all assets (models, textures, etc.) to be fully loaded
        function waitForAssetsToLoad() {
            console.log('‚è≥ Waiting for all 3D assets to load and cache...');
            updateLoadingProgress(80, 'ËºâÂÖ• 3D Ê®°ÂûãË≥áÊ∫ê', '‰∏ãËºâÊ®°ÂûãÊñá‰ª∂ÂíåÁ¥ãÁêÜ...');
            
            var scene = document.querySelector('a-scene');
            if (!scene) {
                console.error('Scene not found');
                hideLoadingSplash();
                return;
            }
            
            // Ensure scene is visible and rendering
            scene.style.display = 'block';
            scene.style.visibility = 'visible';
            
            // Track asset loading
            var assetsLoaded = false;
            var modelsLoaded = 0;
            var totalDownloadSize = 0;
            var modelSizes = {};
            
            // Count total models to load
            var totalModels = 0;
            var modelEntities = document.querySelectorAll('[gltf-model]');
            totalModels = modelEntities.length;
            
            console.log('üì¶ Total assets to load:', totalModels);
            
            if (totalModels === 0) {
                console.warn('‚ö†Ô∏è No GLTF models found, proceeding...');
                onAllAssetsLoaded();
                return;
            }
            
            // Fetch file sizes for all models
            var sizeFetchPromises = [];
            modelEntities.forEach(function(entity) {
                var modelPath = entity.getAttribute('gltf-model');
                if (modelPath) {
                    var promise = fetch(modelPath, { method: 'HEAD' })
                        .then(function(response) {
                            var size = response.headers.get('Content-Length');
                            if (size) {
                                modelSizes[modelPath] = parseInt(size);
                                totalDownloadSize += parseInt(size);
                                console.log('üìä Model size:', modelPath, '-', formatFileSize(parseInt(size)));
                            }
                        })
                        .catch(function(err) {
                            console.warn('Could not fetch size for:', modelPath);
                        });
                    sizeFetchPromises.push(promise);
                }
            });
            
            // Wait for all size fetches to complete
            Promise.all(sizeFetchPromises).then(function() {
                console.log('üìä Total download size:', formatFileSize(totalDownloadSize));
            });
            
            function onModelLoaded(evt) {
                modelsLoaded++;
                var modelPath = evt.target.getAttribute('gltf-model');
                var modelSize = modelSizes[modelPath] || 0;
                var progress = 80 + Math.floor((modelsLoaded / totalModels) * 15);
                
                var sizeText = modelSize > 0 ? ' (' + formatFileSize(modelSize) + ')' : '';
                var totalSizeText = totalDownloadSize > 0 ? ' - Á∏ΩË®à: ' + formatFileSize(totalDownloadSize) : '';
                
                updateLoadingProgress(
                    progress, 
                    'ËºâÂÖ• 3D Ê®°Âûã', 
                    modelsLoaded + ' / ' + totalModels + ' Ê®°ÂûãÂ∑≤‰∏ãËºâ' + sizeText + totalSizeText
                );
                console.log('‚úì Model loaded and cached (' + modelsLoaded + '/' + totalModels + '):', modelPath, sizeText);
                
                if (modelsLoaded >= totalModels && !assetsLoaded) {
                    assetsLoaded = true;
                    onAllAssetsLoaded();
                }
            }
            
            function onModelError(evt) {
                console.error('‚ùå Model failed to load:', evt.target.getAttribute('gltf-model'));
                modelsLoaded++;
                
                var progress = 80 + Math.floor((modelsLoaded / totalModels) * 15);
                updateLoadingProgress(
                    progress, 
                    'ËºâÂÖ• 3D Ê®°Âûã', 
                    modelsLoaded + ' / ' + totalModels + ' (ÈÉ®ÂàÜÂ§±Êïó)'
                );
                
                if (modelsLoaded >= totalModels && !assetsLoaded) {
                    assetsLoaded = true;
                    onAllAssetsLoaded();
                }
            }
            
            // Attach listeners to all model entities
            modelEntities.forEach(function(entity) {
                entity.addEventListener('model-loaded', onModelLoaded);
                entity.addEventListener('model-error', onModelError);
            });
            
            // Fallback timeout (30 seconds)
            var fallbackTimeout = setTimeout(function() {
                if (!assetsLoaded) {
                    console.warn('‚ö†Ô∏è Asset loading timeout after 30s, proceeding anyway (loaded ' + modelsLoaded + '/' + totalModels + ')');
                    assetsLoaded = true;
                    onAllAssetsLoaded();
                }
            }, 30000);
            
            function onAllAssetsLoaded() {
                clearTimeout(fallbackTimeout);
                console.log('‚úÖ All assets loaded and cached in browser');
                updateLoadingProgress(100, 'ÂÆåÊàê', 'ÊâÄÊúâË≥áÊ∫êÂ∑≤ËºâÂÖ•ÔºåÊ∫ñÂÇôÈÄ≤ÂÖ• AR È´îÈ©ó...');
                
                // Wait for AR.js to initialize camera before hiding splash
                waitForCameraReady();
            }
        }
        
        // Wait for AR.js camera/webcam to be ready
        function waitForCameraReady() {
            console.log('üìπ Waiting for AR.js to initialize camera...');
            var scene = document.querySelector('a-scene');
            
            if (!scene) {
                console.error('Scene not found');
                hideLoadingSplash();
                return;
            }
            
            var maxWaitTime = 10000; // 10 seconds max
            var startTime = Date.now();
            var checkInterval;
            
            function checkCamera() {
                var video = document.querySelector('video');
                var elapsed = Date.now() - startTime;
                
                if (video && video.videoWidth > 0 && video.videoHeight > 0) {
                    // Camera is ready with valid dimensions
                    console.log('‚úÖ Camera ready! Dimensions:', video.videoWidth, 'x', video.videoHeight);
                    clearInterval(checkInterval);
                    hideLoadingSplash();
                } else if (elapsed > maxWaitTime) {
                    // Timeout - proceed anyway
                    console.warn('‚ö†Ô∏è Camera initialization timeout after', (elapsed/1000).toFixed(1), 'seconds');
                    if (video) {
                        console.log('Video element exists but dimensions:', video.videoWidth, 'x', video.videoHeight);
                    } else {
                        console.log('No video element found');
                    }
                    clearInterval(checkInterval);
                    hideLoadingSplash();
                } else {
                    // Still waiting
                    if (elapsed % 1000 < 200) { // Log every second
                        console.log('‚è≥ Waiting for camera... (' + (elapsed/1000).toFixed(1) + 's)');
                    }
                }
            }
            
            // Check every 200ms
            checkInterval = setInterval(checkCamera, 200);
            
            // Also listen for AR.js events
            scene.addEventListener('arjs-video-loaded', function() {
                console.log('‚úÖ AR.js video-loaded event fired');
                clearInterval(checkInterval);
                setTimeout(hideLoadingSplash, 500);
            });
        }
        
        // Create a marker and model for a specific model
        function createMarkerForModel(scene, modelName) {
            var config = modelConfigs[modelName];
            if (!config) {
                console.warn('No config found for:', modelName, '- skipping marker creation');
                return;
            }
            
            // Skip if this model failed to load
            if (loadingProgress.failedModels.indexOf(modelName) > -1) {
                console.warn('Skipping failed model:', modelName);
                return;
            }
            
            // Create marker element based on type
            var marker;
            var markerType = config.markerType || 'pattern';
            
            if (markerType === 'barcode') {
                // Barcode/QR marker
                marker = document.createElement('a-marker');
                marker.setAttribute('type', 'pattern');
                marker.setAttribute('url', 'model/' + modelName + '/pattern-marker.patt');
                console.log('Creating barcode marker for:', modelName);
            } else {
                // Pattern marker (default)
                marker = document.createElement('a-marker');
                marker.setAttribute('type', 'pattern');
                marker.setAttribute('url', 'model/' + modelName + '/pattern-marker.patt');
                console.log('Creating pattern marker for:', modelName);
            }
            
            marker.setAttribute('id', 'marker-' + modelName);
            marker.setAttribute('raycaster', 'objects: .clickable');
            
            // Check if this model should orbit around Earth
            if (config.spinAroundEarth && config.earth && config.earth.modelFile) {
                // Create Earth model at center
                var earthEntity = document.createElement('a-entity');
                earthEntity.setAttribute('id', 'earth-' + modelName);
                earthEntity.setAttribute('gltf-model', 'model/' + modelName + '/' + config.earth.modelFile);
                earthEntity.setAttribute('scale', config.earth.size + ' ' + config.earth.size + ' ' + config.earth.size);
                earthEntity.setAttribute('position', config.earth.posX + ' ' + config.earth.posY + ' ' + config.earth.posZ);
                earthEntity.setAttribute('rotation', config.earth.rotX + ' ' + config.earth.rotY + ' ' + config.earth.rotZ);
                marker.appendChild(earthEntity);
                
                // Create orbit container (this will rotate)
                var orbitContainer = document.createElement('a-entity');
                orbitContainer.setAttribute('id', 'orbit-container-' + modelName);
                orbitContainer.setAttribute('position', '0 0 0');
                orbitContainer.setAttribute('rotation', config.orbitTilt + ' 0 0');
                
                // Create model entity at orbit radius
                var modelEntity = document.createElement('a-entity');
                modelEntity.setAttribute('id', 'model-' + modelName);
                var modelFile = config.modelFile || 'model.gltf';
                modelEntity.setAttribute('gltf-model', 'model/' + modelName + '/' + modelFile);
                modelEntity.setAttribute('scale', config.size + ' ' + config.size + ' ' + config.size);
                modelEntity.setAttribute('position', config.orbitRadius + ' 0 0');
                modelEntity.setAttribute('rotation', config.rotX + ' ' + config.rotY + ' ' + config.rotZ);
                
                // Add model to orbit container
                orbitContainer.appendChild(modelEntity);
                
                // Add orbit container to marker
                marker.appendChild(orbitContainer);
                
                // Setup orbit animation
                setupOrbitAnimation(orbitContainer, config.orbitSpeed);
                
                console.log('‚úì Created orbit setup for:', modelName, 'radius:', config.orbitRadius, 'speed:', config.orbitSpeed);
            } else {
                // Standard model without orbit
                var modelEntity = document.createElement('a-entity');
                modelEntity.setAttribute('id', 'model-' + modelName);
                
                // Support both .gltf and .glb files
                var modelFile = config.modelFile || 'model.gltf';
                modelEntity.setAttribute('gltf-model', 'model/' + modelName + '/' + modelFile);
                
                // Apply cached configuration
                if (config) {
                    modelEntity.setAttribute('scale', config.size + ' ' + config.size + ' ' + config.size);
                    modelEntity.setAttribute('position', config.posX + ' ' + config.posY + ' ' + config.posZ);
                    modelEntity.setAttribute('rotation', config.rotX + ' ' + config.rotY + ' ' + config.rotZ);
                }
                
                // Add model to marker
                marker.appendChild(modelEntity);
            }
            
            // Wait for model to load and add proper PBR lighting
            modelEntity.addEventListener('model-loaded', function() {
                console.log('‚úì Model loaded:', modelName);
                
                // Add hemisphere light for better PBR rendering
                var hemisphereLight = document.createElement('a-entity');
                hemisphereLight.setAttribute('light', 'type: hemisphere; color: #FFF; groundColor: #555; intensity: 1.5');
                hemisphereLight.setAttribute('position', '0 2 0');
                marker.appendChild(hemisphereLight);
                
                // Add directional light from multiple angles for PBR reflections
                var keyLight = document.createElement('a-entity');
                keyLight.setAttribute('light', 'type: directional; color: #FFF; intensity: 1.5');
                keyLight.setAttribute('position', '2 4 2');
                marker.appendChild(keyLight);
                
                var fillLight = document.createElement('a-entity');
                fillLight.setAttribute('light', 'type: directional; color: #FFF; intensity: 0.8');
                fillLight.setAttribute('position', '-2 3 -1');
                marker.appendChild(fillLight);
                
                // Add point light close to model for highlights
                var pointLight = document.createElement('a-entity');
                pointLight.setAttribute('light', 'type: point; color: #FFF; intensity: 1; distance: 10; decay: 2');
                pointLight.setAttribute('position', '0 2 1');
                marker.appendChild(pointLight);
                
                console.log('‚úì PBR lighting setup complete for:', modelName);
            });
            
            // Add marker event listeners
            marker.addEventListener('markerFound', function() {
                onMarkerFound(modelName);
            });
            
            marker.addEventListener('markerLost', function() {
                onMarkerLost(modelName);
            });
            
            // Add marker to scene
            scene.appendChild(marker);
            
            console.log('‚úì Created marker for:', modelName);
        }
        
        // Handle marker found event
        function onMarkerFound(modelName) {
            console.log('‚úÖ Marker detected:', modelName, new Date().toLocaleTimeString());
            currentModel = modelName;
            
            // Get model description
            var desc = modelDescriptions[modelName];
            
            // Check if this model has personal_info - show personal info card
            if (desc && desc.personal_info) {
                showPersonalInfo(modelName, desc.personal_info);
            } 
            // Check if this model has mc_game - show MC game briefing card
            else if (desc && desc.mc_game) {
                showMCGameInfo(modelName, desc.mc_game);
            }
            // Check if this model has introduction_info - show introduction info card
            else if (desc && desc.introduction_info) {
                showIntroductionInfo(modelName, desc.introduction_info);
            } 
            // Otherwise show regular AR message
            else {
                // Update AR message with model-specific info
                updateARMessage(modelName);
                
                // Show overlay, speak button and hide instructions
                var hoverMsg = document.getElementById('ar-hover-message');
                var speakBtn = document.getElementById('speak-button');
                
                if (hoverMsg) {
                    hoverMsg.style.display = 'block';
                }
                if (speakBtn) {
                    speakBtn.style.display = 'block';
                }
            }
            
            // Always show video buttons and hide instructions regardless of info type
            var youtubeBtn = document.getElementById('youtube-button');
            var videoBtn = document.getElementById('video-button');
            var instructions = document.getElementById('instructions');
            
            // Show YouTube button if youtube_video_src exists
            if (youtubeBtn && desc && desc.youtube_video_src) {
                youtubeBtn.style.display = 'block';
                youtubeBtn.onclick = function() {
                    window.open(desc.youtube_video_src, '_blank');
                };
            }
            
            // Show Video button if local_video_src exists (priority over YouTube)
            if (videoBtn && desc && desc.local_video_src) {
                videoBtn.style.display = 'block';
                videoBtn.onclick = function() {
                    window.open(desc.local_video_src, '_blank');
                };
                // Hide YouTube button if local video exists
                if (youtubeBtn) {
                    youtubeBtn.style.display = 'none';
                }
            }
            
            if (instructions) {
                instructions.style.display = 'none';
            }
        }
        
        // Handle marker lost event
        function onMarkerLost(modelName) {
            console.log('‚ùå Marker lost:', modelName, new Date().toLocaleTimeString());
            
            // Only hide if this was the current model
            if (currentModel === modelName) {
                currentModel = null;
                
                // Stop any ongoing speech
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                
                // Hide overlay, speak button, video buttons, personal info card, mc game card, introduction info card and show instructions
                var hoverMsg = document.getElementById('ar-hover-message');
                var speakBtn = document.getElementById('speak-button');
                var youtubeBtn = document.getElementById('youtube-button');
                var videoBtn = document.getElementById('video-button');
                var personalInfoCard = document.getElementById('personal-info-card');
                var mcGameCard = document.getElementById('mc-game-card');
                var introductionInfoCard = document.getElementById('introduction-info-card');
                var instructions = document.getElementById('instructions');
                
                if (hoverMsg) {
                    hoverMsg.style.display = 'none';
                }
                if (speakBtn) {
                    speakBtn.style.display = 'none';
                    speakBtn.classList.remove('speaking');
                    speakBtn.textContent = 'üîä Èü≥È†ªËß£Ë™™';
                }
                if (youtubeBtn) {
                    youtubeBtn.style.display = 'none';
                    youtubeBtn.onclick = null;
                }
                if (videoBtn) {
                    videoBtn.style.display = 'none';
                    videoBtn.onclick = null;
                }
                if (personalInfoCard) {
                    personalInfoCard.style.display = 'none';
                }
                if (mcGameCard) {
                    mcGameCard.style.display = 'none';
                }
                if (introductionInfoCard) {
                    introductionInfoCard.style.display = 'none';
                }
                if (instructions) {
                    instructions.style.display = 'block';
                }
            }
        }
        
        // Initialize fallback mode for single model
        function initializeFallbackMode() {
            console.log('Initializing fallback single-model mode');
            // Fallback to original single model behavior
            var modelName = 'sputnik1';
            availableModels = [modelName];
            
            // Set default configs
            modelConfigs[modelName] = {
                size: 0.3, posX: 0, posY: 0, posZ: 0, rotX: 0, rotY: 0, rotZ: 0
            };
            modelDescriptions[modelName] = {
                title: 'AR Model',
                hk_narrative: 'Point camera at marker',
                youtube_video_src: null,
                local_video_src: null,
                personal_info: null,
                introduction_info: null,
                mc_game: null
            };
            
            initializeARScene();
        }
        
        document.addEventListener('DOMContentLoaded', function () {
            // Scene initialization is now handled by the model loading process
            console.log('DOM loaded - waiting for model configurations...');
        });
        
        // Function to update AR message content
        function updateARMessage(modelName) {
            var desc = modelDescriptions[modelName];
            
            var titleEl = document.getElementById('model-title');
            
            if (titleEl && desc && desc.title) {
                titleEl.textContent = desc.title;
            }
        }
        
        // Speak the narrative using Web Speech API
        function speakNarrative(modelName) {
            var desc = modelDescriptions[modelName];
            
            if (!desc || !desc.hk_narrative) {
                console.warn('No narrative found for:', modelName);
                return;
            }
            
            // Stop any ongoing speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // Create utterance
            currentUtterance = new SpeechSynthesisUtterance(desc.hk_narrative);
            
            // Set language to Cantonese (Hong Kong)
            currentUtterance.lang = 'zh-HK';
            
            // Try to find a Cantonese voice
            var voices = speechSynthesis.getVoices();
            var cantoneseVoice = voices.find(function(voice) {
                return voice.lang === 'zh-HK' || voice.lang.startsWith('zh-HK');
            });
            
            if (cantoneseVoice) {
                currentUtterance.voice = cantoneseVoice;
            }
            
            // Set speech parameters
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;
            
            // Update button state
            var speakBtn = document.getElementById('speak-button');
            if (speakBtn) {
                speakBtn.classList.add('speaking');
                speakBtn.textContent = '‚èπ ÂÅúÊ≠¢';
            }
            
            // Handle speech end
            currentUtterance.onend = function() {
                if (speakBtn) {
                    speakBtn.classList.remove('speaking');
                    speakBtn.textContent = 'üîä Èü≥È†ªËß£Ë™™';
                }
            };
            
            // Handle speech error
            currentUtterance.onerror = function(event) {
                console.error('Speech error:', event);
                if (speakBtn) {
                    speakBtn.classList.remove('speaking');
                    speakBtn.textContent = 'üîä Èü≥È†ªËß£Ë™™';
                }
            };
            
            // Speak
            speechSynthesis.speak(currentUtterance);
            console.log('üîä Speaking:', desc.title);
        }
        
        // Toggle speech (play/stop)
        function toggleSpeech() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                var speakBtn = document.getElementById('speak-button');
                if (speakBtn) {
                    speakBtn.classList.remove('speaking');
                    speakBtn.textContent = 'üîä Èü≥È†ªËß£Ë™™';
                }
            } else if (currentModel) {
                speakNarrative(currentModel);
            }
        }
        
        // Show personal info card for astronauts/personnel
        function showPersonalInfo(modelName, personalInfo) {
            var card = document.getElementById('personal-info-card');
            var personName = document.getElementById('person-name');
            var personNationality = document.getElementById('person-nationality');
            var personBirth = document.getElementById('person-birth');
            var personMission = document.getElementById('person-mission');
            var personMotoList = document.getElementById('person-moto-list');
            var videoSection = document.getElementById('person-video-section');
            var videoBtn = document.getElementById('personal-video-btn');
            var videoText = document.getElementById('personal-video-text');
            
            if (!card) return;
            
            // Update person name
            if (personName && personalInfo.name_zh) {
                personName.textContent = personalInfo.name_zh;
            }
            
            // Update nationality
            if (personNationality && personalInfo.nationality) {
                personNationality.textContent = personalInfo.nationality;
            }
            
            // Update birth date
            if (personBirth && personalInfo.birth_date) {
                personBirth.textContent = 'Âá∫Áîü: ' + personalInfo.birth_date;
            }
            
            // Update mission
            if (personMission && personalInfo.main_mission) {
                personMission.textContent = personalInfo.main_mission;
            }
            
            // Update moto/quotes
            if (personMotoList && personalInfo.moto && personalInfo.moto.length > 0) {
                personMotoList.innerHTML = '';
                personalInfo.moto.forEach(function(quote) {
                    var motoItem = document.createElement('div');
                    motoItem.className = 'moto-item';
                    motoItem.textContent = quote;
                    personMotoList.appendChild(motoItem);
                });
            }
            
            // Handle video button - check for video sources
            var desc = modelDescriptions[modelName];
            var hasVideo = false;
            var videoSrc = null;
            var isYoutube = false;
            
            // Check personal_info first, then desc_info
            if (personalInfo.local_video_src) {
                hasVideo = true;
                videoSrc = personalInfo.local_video_src;
                isYoutube = false;
            } else if (personalInfo.youtube_video_src) {
                hasVideo = true;
                videoSrc = personalInfo.youtube_video_src;
                isYoutube = true;
            } else if (desc && desc.local_video_src) {
                hasVideo = true;
                videoSrc = desc.local_video_src;
                isYoutube = false;
            } else if (desc && desc.youtube_video_src) {
                hasVideo = true;
                videoSrc = desc.youtube_video_src;
                isYoutube = true;
            }
            
            // Show/hide video section based on availability
            if (videoSection) {
                if (hasVideo) {
                    videoSection.style.display = 'block';
                    
                    // Update button text
                    if (videoText) {
                        videoText.textContent = isYoutube ? 'ËßÄÁúã YouTube ÂΩ±Áâá' : 'Êí≠ÊîæÊú¨Âú∞ÂΩ±Áâá';
                    }
                    
                    // Set up click handler
                    if (videoBtn) {
                        videoBtn.onclick = function() {
                            if (isYoutube) {
                                window.open(videoSrc, '_blank');
                            } else {
                                // For local video, you might want to implement a modal or redirect
                                window.open(videoSrc, '_blank');
                            }
                        };
                    }
                } else {
                    videoSection.style.display = 'none';
                }
            }
            
            // Show the card
            card.style.display = 'block';
            
            console.log('‚úÖ Personal info displayed for:', personalInfo.name_zh || modelName);
        }
        
        // Hide personal info card
        function hidePersonalInfo() {
            var card = document.getElementById('personal-info-card');
            if (card) {
                card.style.display = 'none';
            }
        }

        // Show introduction info card for missions/projects
        function showIntroductionInfo(modelName, introductionInfo) {
            var card = document.getElementById('introduction-info-card');
            var introTitle = document.getElementById('intro-title');
            var introIcon = document.getElementById('intro-icon');
            var introSpeakBtn = document.getElementById('intro-speak-btn');
            var introSpeakText = document.getElementById('intro-speak-text');
            var videoSection = document.getElementById('intro-video-section');
            var videoBtn = document.getElementById('intro-video-btn');
            var videoText = document.getElementById('intro-video-text');
            
            if (!card) return;
            
            // Update title
            if (introTitle && introductionInfo.title) {
                introTitle.textContent = introductionInfo.title;
            }
            
            // Handle icon display
            if (introIcon) {
                if (introductionInfo.icon) {
                    // Map icon names to emojis
                    var iconMap = {
                        'rocket': 'üöÄ',
                        'satellite': 'üõ∞Ô∏è',
                        'astronaut': 'üë®‚ÄçüöÄ',
                        'moon': 'üåô',
                        'earth': 'üåç',
                        'mars': 'üî¥',
                        'space': 'üåå',
                        'station': 'üèóÔ∏è'
                    };
                    
                    var iconEmoji = iconMap[introductionInfo.icon] || 'üöÄ'; // Default to rocket
                    introIcon.textContent = iconEmoji;
                    introIcon.classList.add('show');
                } else {
                    introIcon.classList.remove('show');
                }
            }
            
            // Set up speech button
            if (introSpeakBtn && introductionInfo.hk_narrative) {
                // Store the narrative for speech
                introSpeakBtn.setAttribute('data-narrative', introductionInfo.hk_narrative);
                introSpeakBtn.setAttribute('data-title', introductionInfo.title || modelName);
                
                // Set up click handler for speech
                introSpeakBtn.onclick = function() {
                    toggleIntroductionSpeech();
                };
            }
            
            // Handle video button - check for video sources
            var hasVideo = false;
            var videoSrc = null;
            var isYoutube = false;
            
            // Check introduction_info for video sources
            if (introductionInfo.local_video_src) {
                hasVideo = true;
                videoSrc = introductionInfo.local_video_src;
                isYoutube = false;
            } else if (introductionInfo.youtube_video_src) {
                hasVideo = true;
                videoSrc = introductionInfo.youtube_video_src;
                isYoutube = true;
            }
            
            // Show/hide video section based on availability
            if (videoSection) {
                if (hasVideo) {
                    videoSection.style.display = 'block';
                    
                    // Update button text
                    if (videoText) {
                        videoText.textContent = isYoutube ? 'ËßÄÁúã YouTube ÂΩ±Áâá' : 'Êí≠ÊîæÊú¨Âú∞ÂΩ±Áâá';
                    }
                    
                    // Set up click handler
                    if (videoBtn) {
                        videoBtn.onclick = function() {
                            if (isYoutube) {
                                window.open(videoSrc, '_blank');
                            } else {
                                // For local video, you might want to implement a modal or redirect
                                window.open(videoSrc, '_blank');
                            }
                        };
                    }
                } else {
                    videoSection.style.display = 'none';
                }
            }
            
            // Show the card
            card.style.display = 'block';
            
            console.log('‚úÖ Introduction info displayed for:', introductionInfo.title || modelName);
        }

        // Hide introduction info card
        function hideIntroductionInfo() {
            var card = document.getElementById('introduction-info-card');
            if (card) {
                card.style.display = 'none';
            }
            
            // Stop any ongoing speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // Reset speech button
            var introSpeakBtn = document.getElementById('intro-speak-btn');
            var introSpeakText = document.getElementById('intro-speak-text');
            if (introSpeakBtn) {
                introSpeakBtn.classList.remove('speaking');
            }
            if (introSpeakText) {
                introSpeakText.textContent = 'üîä Ë™ûÈü≥‰ªãÁ¥π';
            }
        }

        // Toggle speech for introduction info
        function toggleIntroductionSpeech() {
            var introSpeakBtn = document.getElementById('intro-speak-btn');
            var introSpeakText = document.getElementById('intro-speak-text');
            
            if (speechSynthesis.speaking) {
                // Stop speaking
                speechSynthesis.cancel();
                if (introSpeakBtn) {
                    introSpeakBtn.classList.remove('speaking');
                }
                if (introSpeakText) {
                    introSpeakText.textContent = 'üîä Ë™ûÈü≥‰ªãÁ¥π';
                }
            } else {
                // Start speaking
                var narrative = introSpeakBtn ? introSpeakBtn.getAttribute('data-narrative') : null;
                var title = introSpeakBtn ? introSpeakBtn.getAttribute('data-title') : null;
                
                if (narrative) {
                    // Stop any ongoing speech
                    if (speechSynthesis.speaking) {
                        speechSynthesis.cancel();
                    }
                    
                    // Create utterance
                    var utterance = new SpeechSynthesisUtterance(narrative);
                    
                    // Set language to Cantonese (Hong Kong)
                    utterance.lang = 'zh-HK';
                    
                    // Try to find a Cantonese voice
                    var voices = speechSynthesis.getVoices();
                    var cantoneseVoice = voices.find(function(voice) {
                        return voice.lang === 'zh-HK' || voice.lang.startsWith('zh-HK');
                    });
                    
                    if (cantoneseVoice) {
                        utterance.voice = cantoneseVoice;
                    }
                    
                    // Set speech parameters
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    // Update button state
                    if (introSpeakBtn) {
                        introSpeakBtn.classList.add('speaking');
                    }
                    if (introSpeakText) {
                        introSpeakText.textContent = '‚èπ ÂÅúÊ≠¢Êí≠Êîæ';
                    }
                    
                    // Handle speech end
                    utterance.onend = function() {
                        if (introSpeakBtn) {
                            introSpeakBtn.classList.remove('speaking');
                        }
                        if (introSpeakText) {
                            introSpeakText.textContent = 'üîä Ë™ûÈü≥‰ªãÁ¥π';
                        }
                    };
                    
                    // Handle speech error
                    utterance.onerror = function(event) {
                        console.error('Speech error:', event);
                        if (introSpeakBtn) {
                            introSpeakBtn.classList.remove('speaking');
                        }
                        if (introSpeakText) {
                            introSpeakText.textContent = 'üîä Ë™ûÈü≥‰ªãÁ¥π';
                        }
                    };
                    
                    // Speak
                    speechSynthesis.speak(utterance);
                    console.log('üîä Speaking introduction:', title || 'Introduction');
                }
            }
        }
        
        // Show MC Game mission briefing card
        function showMCGameInfo(modelName, mcGameInfo) {
            console.log('üéØ Showing MC Game info for:', modelName, mcGameInfo);
            
            var card = document.getElementById('mc-game-card');
            var titleEl = document.getElementById('mc-game-title');
            var acceptBtn = document.getElementById('mc-game-accept-btn');
            
            if (!card) return;
            
            // Hide other elements
            var hoverMsg = document.getElementById('ar-hover-message');
            var speakBtn = document.getElementById('speak-button');
            var youtubeBtn = document.getElementById('youtube-button');
            var videoBtn = document.getElementById('video-button');
            var instructions = document.getElementById('instructions');
            var personalInfoCard = document.getElementById('personal-info-card');
            var introductionInfoCard = document.getElementById('introduction-info-card');
            
            if (hoverMsg) hoverMsg.style.display = 'none';
            if (speakBtn) speakBtn.style.display = 'none';
            if (youtubeBtn) youtubeBtn.style.display = 'none';
            if (videoBtn) videoBtn.style.display = 'none';
            if (instructions) instructions.style.display = 'none';
            if (personalInfoCard) personalInfoCard.style.display = 'none';
            if (introductionInfoCard) introductionInfoCard.style.display = 'none';
            
            // Update title
            if (titleEl && mcGameInfo.title) {
                titleEl.textContent = mcGameInfo.title;
            }
            
            // Update button text
            if (acceptBtn && mcGameInfo.mc_game_button_text) {
                acceptBtn.textContent = mcGameInfo.mc_game_button_text;
            }
            
            // Set up button click handler
            if (acceptBtn && mcGameInfo.mc_game_url) {
                acceptBtn.onclick = function() {
                    console.log('üöÄ Opening MC Game:', mcGameInfo.mc_game_url);
                    window.open(mcGameInfo.mc_game_url, '_blank');
                };
            }
            
            // Show the card
            card.style.display = 'block';
            
            console.log('‚úÖ MC Game briefing displayed for:', mcGameInfo.title || modelName);
        }

        // Hide MC Game mission briefing card
        function hideMCGameInfo() {
            var card = document.getElementById('mc-game-card');
            if (card) {
                card.style.display = 'none';
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('=== AR Viewer with Multi-Marker Support and Speech ===');
            
            // Set up speak button
            var speakBtn = document.getElementById('speak-button');
            if (speakBtn) {
                speakBtn.addEventListener('click', toggleSpeech);
            }
            
            // Load voices (needed for some browsers)
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = function() {
                    speechSynthesis.getVoices();
                };
            }
        });
    </script>
</body>
</html>
